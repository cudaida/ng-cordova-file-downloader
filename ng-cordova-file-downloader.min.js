angular.module("com.verico.ng-cordova-file-downloader",[]),angular.module("com.verico.ng-cordova-file-downloader").config(["$provide",function(a){a.decorator("$q",["$delegate",function(a){var b=a;return b.allSettled=b.allSettled||function(a){var c=b.defer();if(!angular.isArray(a))throw"allSettled can only handle an array of promises (for now)";var d=[],e=[],f=!1;angular.forEach(a,function(a,b){d[b]=!1});var g=function(a,b,c,d){var e=!0;angular.forEach(a,function(a){a||(e=!1)}),e&&(d?c.reject(b):c.resolve(b))};return angular.forEach(a,function(a,h){b.when(a).then(function(a){d[h]=!0,e[h]=a,g(d,e,c,f)},function(a){d[h]=!0,e[h]=a,f=!0,g(d,e,c,f)})}),c.promise},b}])}]),angular.module("com.verico.ng-cordova-file-downloader").service("ngCordovaFileDownloader",["$q","$timeout","appSettings","fileTransfer",function(a,b,c,d){var e="com.verico.file-default",f={fullPath:null,fileSystem:null,downloadUrl:null,currentFile:null},g=function(){return i().then(k)},h=function(a){console.log("Error:"+JSON.stringify(a))},i=function(){var b=a.defer();return null===f.fileSystem?d.getFileSystem().then(function(a){f.fileSystem=a,b.resolve()}):b.resolve(),b.promise},j=function(){function b(){c.resolve(e)}var c=a.defer();return f.fileSystem.root.getDirectory(e,{create:!0,exclusive:!1},b,h),c.promise},k=function(){var b=a.defer();return null===f.fullPath?j().then(function(a){var c=a+"/dummy.html";f.fileSystem.root.getFile(c,{create:!0,exclusive:!1},function(a){f.fullPath=a.fullPath.replace("dummy.html",""),b.resolve()},h)}):b.resolve(),b.promise},l=function(b){var c=a.defer(),d=e+"/"+b;return f.fileSystem.root.getFile(d,{create:!1,exclusive:!1},function(a){c.resolve(a.fullPath)},function(){c.reject()}),c.promise},m=function(b,e){var f=a.defer(),g=d.getFileTransfer(),h=encodeURI(b);return g.download(h,e,function(a){f.resolve(a.fullPath)},function(a){f.reject("Image download failed:"+JSON.stringify(a))},!1,{headers:{Authorization:c.getLoginInfo()}}),f.promise},n=function(b){var c=a.defer(),d=e+"/"+b,g=function(a){a.file(function(a){c.resolve(a)},c.reject)},h=function(){c.reject()};return f.fileSystem.root.getFile(d,{create:!1,exclusive:!1},g,h),c.promise},o=function(b,c,d){var e=a.defer(),g=4,h=function(a,f){return d++,f?void(f.size>500?e.resolve(a):f.size<500&&d>=g?(console.log("getFileSize NOT OK, size: :"+size),f.remove(function(){console.log("File removed after failed tryes:"+f.fullPath)},function(){console.log("File removed failed:"+f.fullPath)}),e.reject()):(console.log("getFileSize NOT OK. Try : "+d+" size:"+size),o(b,c,d).then(e.resolve,e.reject))):void e.reject()};return g>d?m(b,f.fullPath+c).then(function(a){n(c).then(function(b){h(a,b)},function(){h()})},function(a){console.log("Download file failed: "+a),e.reject()}):e.reject(),e.promise},p=function(b,c){var d=a.defer();return g().then(function(){l(c).then(d.resolve,function(){o(b,c,0).then(d.resolve,d.reject)})}),d.promise},q=function(a){e=a},r={downloadFileList:function(c){var d=a.defer(),e=!1,f=0,g={getCount:function(){return f},shouldCancel:function(a){e=a}},h=r.getNextPart(0,c),i=h.length,j=function(a){b(function(){if(i<c.length&&!e){var a=r.getNextPart(i,c);i+=a.length,r.downloadFileSection(a).then(j)}else d.resolve()},0),f+=a,d.notify(g)};return r.downloadFileSection(h).then(j),d.promise},getNextPart:function(a,b){var c,d=10;return c=b.length>a+(d-1)?b.slice(a,a+d):b.slice(a,b.length)},downloadFileSection:function(b){var c=a.defer(),d=[];_.each(b,function(a){var b=p(a.url,a.name);d.push(b)});var e=function(){c.resolve(d.length)},f=function(){console.log("All setteled with fail count:"+d.length),c.resolve(d.length)};return a.allSettled(d).then(e,f),c.promise}};return{setSaveFolder:q,downloadFile:p,downloadFileList:r.downloadFileList}}]),angular.module("com.verico.ng-cordova-file-downloader").service("fileTransfer",["$q",function(a){var b=null,c=function(){return null===b&&(b=new FileTransfer),b},d=function(){function b(a){d.resolve(a)}function c(a){d.reject(a)}var d=a.defer();return window.requestFileSystem(LocalFileSystem.PERSISTENT,0,b,c),d.promise};return{getFileTransfer:c,getFileSystem:d}}]);