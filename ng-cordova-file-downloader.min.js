angular.module("com.verico.ng-cordova-file-downloader",[]),angular.module("com.verico.ng-cordova-file-downloader").config(["$provide",function(a){a.decorator("$q",["$delegate",function(a){var b=a;return b.allSettled=b.allSettled||function(a){var c=b.defer();if(!angular.isArray(a))throw"allSettled can only handle an array of promises (for now)";var d=[],e=[],f=!1;angular.forEach(a,function(a,b){d[b]=!1});var g=function(a,b,c,d){var e=!0;angular.forEach(a,function(a){a||(e=!1)}),e&&(d?c.reject(b):c.resolve(b))};return angular.forEach(a,function(a,h){b.when(a).then(function(a){d[h]=!0,e[h]=a,g(d,e,c,f)},function(a){d[h]=!0,e[h]=a,f=!0,g(d,e,c,f)})}),c.promise},b}])}]),angular.module("com.verico.ng-cordova-file-downloader").service("downloadFeedbackFactory",function(){var a=function(a,b,c,d){return{success:a,url:b,name:c,fullPath:d}};return{feedback:a}}),angular.module("com.verico.ng-cordova-file-downloader").service("ngCordovaFileDownloader",["$q","$timeout","appSettings","fileTransfer","downloadFeedbackFactory",function(a,b,c,d,e){var f="com.verico.file-default",g={fullPath:null,fileSystem:null,downloadUrl:null,currentFile:null},h=function(){return j().then(l)},i=function(a){console.log("Error:"+JSON.stringify(a))},j=function(){var b=a.defer();return null===g.fileSystem?d.getFileSystem().then(function(a){g.fileSystem=a,b.resolve()}):b.resolve(),b.promise},k=function(){function b(){c.resolve(f)}var c=a.defer();return g.fileSystem.root.getDirectory(f,{create:!0,exclusive:!1},b,i),c.promise},l=function(){var b=a.defer();return null===g.fullPath?k().then(function(a){var c=a+"/dummy.html";g.fileSystem.root.getFile(c,{create:!0,exclusive:!1},function(a){g.fullPath=a.fullPath.replace("dummy.html",""),b.resolve()},i)}):b.resolve(),b.promise},m=function(b){var c=a.defer(),d=f+"/"+b;return g.fileSystem.root.getFile(d,{create:!1,exclusive:!1},function(a){c.resolve(a.fullPath)},function(){c.reject()}),c.promise},n=function(b,e){var f=a.defer(),g=d.getFileTransfer(),h=encodeURI(b);return g.download(h,e,function(a){f.resolve(a.fullPath)},function(a){f.reject("Image download failed:"+JSON.stringify(a))},!1,{headers:{Authorization:c.getLoginInfo()}}),f.promise},o=function(b){var c=a.defer(),d=f+"/"+b,e=function(a){a.file(function(a){c.resolve(a)},c.reject)},h=function(){c.reject()};return g.fileSystem.root.getFile(d,{create:!1,exclusive:!1},e,h),c.promise},p=function(b,c,d){var f=a.defer(),h=4,i=function(a,g){return d++,g?void(g.size>500?f.resolve(e.feedback(!0,b,c,a)):g.size<500&&d>=h?(console.log("getFileSize NOT OK, size: :"+g.size),g.remove(function(){console.log("File removed after failed tryes:"+a)},function(){console.log("File removed failed:"+a)}),f.reject(e.feedback(!1,b,c))):(console.log("getFileSize NOT OK. Try : "+d+" size:"+g.size),p(b,c,d).then(f.resolve,f.reject))):void f.reject(e.feedback(!1,b,c))};return h>d?n(b,g.fullPath+c).then(function(a){o(c).then(function(b){i(a,b)},function(){i()})},function(a){console.log("Download file failed: "+a),f.reject(e.feedback(!1,b,c))}):f.reject(e.feedback(!1,b,c)),f.promise},q=function(b,c){var d=a.defer();return h().then(function(){m(c).then(d.resolve,function(){p(b,c,0).then(d.resolve,d.reject)})}),d.promise},r=function(a){f=a},s={downloadFileList:function(c){var d=a.defer(),e=!1,f=0,g=[],h={getCount:function(){return f},shouldCancel:function(a){e=a}},i=s.getNextPart(0,c),j=i.length,k=function(a){_.each(a,function(a){g.push(a)}),b(function(){if(j<c.length&&!e){var a=s.getNextPart(j,c);j+=a.length,s.downloadFileSection(a).then(k)}else d.resolve(g)},0),f+=a.length,d.notify(h)};return s.downloadFileSection(i).then(k),d.promise},getNextPart:function(a,b){var c,d=10;return c=b.length>a+(d-1)?b.slice(a,a+d):b.slice(a,b.length)},downloadFileSection:function(b){var c=a.defer(),d=[];_.each(b,function(a){var b=q(a.url,a.name);d.push(b)});var e=function(a){c.resolve(a)},f=function(a){c.resolve(a)};return a.allSettled(d).then(e,f),c.promise}};return{setSaveFolder:r,downloadFile:q,downloadFileList:s.downloadFileList}}]),angular.module("com.verico.ng-cordova-file-downloader").service("fileTransfer",["$q",function(a){var b=null,c=function(){return null===b&&(b=new FileTransfer),b},d=function(){function b(a){d.resolve(a)}function c(a){d.reject(a)}var d=a.defer();return window.requestFileSystem(LocalFileSystem.PERSISTENT,0,b,c),d.promise};return{getFileTransfer:c,getFileSystem:d}}]);