angular.module("com.verico.ng-cordova-file-downloader",[]),angular.module("com.verico.ng-cordova-file-downloader").service("fileDownloaderList",["$q","$timeout","appSettings","fileDownloaderSingle",function(a,b,c,d){var e={},f={};return e.downloadFileList=function(c){var d=a.defer(),e=!1,g=0,h=[],i={getCount:function(){return g},shouldCancel:function(a){e=a}},j=f.getNextPart(0,c),k=j.length,l=function(a){angular.forEach(a,function(a){h.push(a)}),b(function(){if(k<c.length&&!e){var a=f.getNextPart(k,c);k+=a.length,f.downloadFileSection(a).then(l)}else d.resolve(h)},0),g+=a.length,d.notify(i)};return f.downloadFileSection(j).then(l),d.promise},f.getNextPart=function(a,b){var c,d=10;return c=b.length>a+(d-1)?b.slice(a,a+d):b.slice(a,b.length)},f.downloadFileSection=function(b){var c=a.defer(),e=[];angular.forEach(b,function(a){var b=d.downloadFileFromUrl(a.url,a.name);e.push(b)});var f=function(a){c.resolve(a)},g=function(a){c.resolve(a)};return a.allSettled(e).then(f,g),c.promise},e}]),angular.module("com.verico.ng-cordova-file-downloader").service("fileDownloaderSingle",["$q","$timeout","appSettings","fileTransfer","downloadFileSystemHelper","downloadFeedbackFactory",function(a,b,c,d,e,f){var g={},h={};return g.setSaveFolderPath=e.setSaveFolderPath,h.startFileDownload=function(b,f){var g=a.defer();return e.getFullFilePath().then(function(a){var e=a+f,h=d.getFileTransfer(),i=encodeURI(b),j={};c&&(j={Authorization:c.getLoginInfo()}),h.download(i,e,function(a){g.resolve("function"==typeof a.toURL?a.toURL():a.fullPath)},function(a){g.reject("Image download failed:"+JSON.stringify(a))},!1,{headers:j})},g.reject),g.promise},g.downloadFileFromUrl=function(b,c){var d=a.defer();return e.checkIfFileExists(c).then(d.resolve,function(){h.startFileDownload(b,c).then(function(a){d.resolve(f.feedback(!0,b,c,a))},function(){d.reject(f.feedback(!1,b,c))})}),d.promise},g}]),angular.module("com.verico.ng-cordova-file-downloader").service("ngCordovaFileDownloader",["fileDownloaderSingle","fileDownloaderList",function(a,b){return{setSaveFolder:a.setSaveFolderPath,downloadFile:a.downloadFileFromUrl,downloadFileList:b.downloadFileList}}]),angular.module("com.verico.ng-cordova-file-downloader").config(["$provide",function(a){a.decorator("$q",["$delegate",function(a){var b=a;return b.allSettled=b.allSettled||function(a){var c=b.defer();if(!angular.isArray(a))throw"allSettled can only handle an array of promises (for now)";var d=[],e=[],f=!1;angular.forEach(a,function(a,b){d[b]=!1});var g=function(a,b,c,d){var e=!0;angular.forEach(a,function(a){a||(e=!1)}),e&&(d?c.reject(b):c.resolve(b))};return angular.forEach(a,function(a,h){b.when(a).then(function(a){d[h]=!0,e[h]=a,g(d,e,c,f)},function(a){d[h]=!0,e[h]=a,f=!0,g(d,e,c,f)})}),c.promise},b}])}]),angular.module("com.verico.ng-cordova-file-downloader").service("downloadFeedbackFactory",function(){var a=function(a,b,c,d){return{success:a,url:b,name:c,fullPath:d}};return{feedback:a}}),angular.module("com.verico.ng-cordova-file-downloader").service("downloadFileSystemHelper",["$q","$timeout","appSettings","fileTransfer","downloadFeedbackFactory",function(a,b,c,d,e){var f="com.verico.file-default",g={fullPath:null,fileSystem:null,downloadUrl:null,currentFile:null},h={},i={};return i.onError=function(a){console.log("Error:"+JSON.stringify(a))},i.createFolder=function(b){function c(){d.resolve(b)}var d=a.defer();return g.fileSystem.root.getDirectory(b,{create:!0,exclusive:!1},c,i.onError),d.promise},i.getFileSystem=function(){var b=a.defer();return null===g.fileSystem?d.getFileSystem().then(function(a){g.fileSystem=a,b.resolve()}):b.resolve(),b.promise},h.getFullFilePath=function(){var b=a.defer();return null===g.fullPath?i.createFolder(f).then(function(a){var c=a+"/dummy.html";g.fileSystem.root.getFile(c,{create:!0,exclusive:!1},function(a){var c;c="function"==typeof a.toURL?a.toURL().replace("dummy.html",""):a.fullPath.replace("dummy.html",""),g.fullPath=c,b.resolve(g.fullPath)},i.onError)}):b.resolve(g.fullPath),b.promise},h.checkIfFileExists=function(b){return i.initDownloader().then(function(){var c=a.defer(),d=f+"/"+b;return g.fileSystem.root.getFile(d,{create:!1,exclusive:!1},function(a){var d;d="function"==typeof a.toURL?a.toURL():a.fullPath,c.resolve(e.feedback(!0,"",b,d))},function(){c.reject()}),c.promise})},i.initDownloader=function(){return i.getFileSystem()},h.setSaveFolderPath=function(a){f=a},h}]),angular.module("com.verico.ng-cordova-file-downloader").service("fileTransfer",["$q",function(a){var b=null,c={};return c.getFileTransfer=function(){return null===b&&(b=new FileTransfer),b},c.getFileSystem=function(){function b(a){d.resolve(a)}function c(a){d.reject(a)}var d=a.defer();return window.requestFileSystem(LocalFileSystem.PERSISTENT,0,b,c),d.promise},c}]);